<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockSell - 한국 주식 자동매매 시스템</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
</head>
<body>
    <div class="app-container">
        <header class="top-bar">
            <div class="logo">StockSell <span>Auto</span></div>
            <div class="header-controls">
                <button id="btn-link-account" class="btn-account">🔗 나무 증권 연동</button>
                <div class="status-indicator">
                    <span class="dot active"></span> 시스템 가동중
                </div>
            </div>
        </header>

        <!-- Account Settings Modal -->
        <div id="accountModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>🏦 NH투자증권(나무) API 설정</h2>
                <p class="modal-note">* NH투자증권 Open API Key가 필요합니다.</p>
                <form id="nh-auth-form">
                    <div class="input-group">
                        <label>App Key</label>
                        <input type="text" id="nhAppKey" placeholder="Open API App Key" required>
                    </div>
                    <div class="input-group">
                        <label>App Secret</label>
                        <input type="password" id="nhAppSecret" placeholder="Open API Secret Key" required>
                    </div>
                    <div class="input-group">
                        <label>계좌번호 (종합매매)</label>
                        <input type="text" id="nhAccount" placeholder="12345678-01" required>
                    </div>
                    <button type="submit" class="btn-primary">연동 저장 및 테스트</button>
                </form>
            </div>
        </div>

        <main class="dashboard-grid">
            <!-- Market Overview Panel (New) -->
            <section class="card market-panel">
                <div class="panel-header-row">
                    <h2>📊 실시간 시장 동향 & AI 분석</h2>
                    <button id="btn-analyze" class="btn-ai">✨ Gemini Market 분석</button>
                </div>
                <div id="ai-result" class="ai-result-box" style="display:none;">
                    <strong>🤖 Gemini 2.0 Flash의 분석:</strong>
                    <p id="ai-text">분석 중...</p>
                </div>
                <div class="market-content">
                    <div class="chart-container">
                        <canvas id="marketChart"></canvas>
                    </div>
                    <div class="movers-list">
                        <h3>🔥 급등 종목 Top 5</h3>
                        <ul id="top-risers">
                            <li>데이터 로딩중...</li>
                        </ul>
                        <h3 class="fall-header">💧 급락 종목 Top 5</h3>
                        <ul id="top-fallers">
                            <li>데이터 로딩중...</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Left Panel: Strategy Configuration -->
            <section class="card config-panel">
                <h2>📈 매매 전략 설정</h2>
                
                <!-- 1. Stock Search & Info -->
                <div class="search-section">
                    <label>종목 검색</label>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="종목명 또는 코드 입력 (예: 삼성전자)" autocomplete="off">
                        <button id="btn-search-manual" class="btn-secondary">검색</button>
                    </div>
                    <ul id="searchResults" class="search-results"></ul>
                </div>

                <div id="selectedStockInfo" class="stock-info-card" style="display:none;">
                    <div class="info-header">
                        <h3 id="infoName">삼성전자</h3>
                        <span id="infoCode" class="code-badge">005930</span>
                    </div>
                    <div class="info-price-row">
                        <span id="infoPrice" class="current-price">72,500</span>
                        <span class="currency">KRW</span>
                        <span id="infoChange" class="change-rate up">+1.2%</span>
                    </div>
                    <p class="updated-time">최근 조회: <span id="infoTime">14:30:00</span></p>
                </div>

                <!-- 2. Strategy Form -->
                <form id="strategy-form">
                    <!-- Hidden inputs to store selected stock data -->
                    <input type="hidden" id="stockCode">
                    <input type="hidden" id="stockName">
                    <input type="hidden" id="basePrice">

                    <div class="strategy-inputs">
                        <div class="row">
                            <div class="input-group">
                                <label>매수 조건 (%)</label>
                                <input type="number" id="buyThreshold" placeholder="-2.0" step="0.1" required>
                            </div>
                            <div class="input-group">
                                <label>매도 조건 (%)</label>
                                <input type="number" id="sellThreshold" placeholder="3.5" step="0.1" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>주문 수량 (주)</label>
                            <input type="number" id="quantity" value="10" min="1" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="btnAddStrategy" disabled>전략 등록 (종목을 먼저 선택하세요)</button>
                </form>
            </section>

            <!-- Center Panel: Live Market & Active Bots -->
            <section class="card monitoring-panel">
                <h2>⚡ 실시간 감시 현황 (시뮬레이션)</h2>
                <div class="table-container">
                    <table id="bot-table">
                        <thead>
                            <tr>
                                <th>종목</th>
                                <th>현재가</th>
                                <th>변동률</th>
                                <th>상태</th>
                                <th>목표 매수</th>
                                <th>목표 매도</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="bot-list">
                            <!-- Bots will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
                <div class="simulation-controls">
                    <button id="toggleSim" class="btn-secondary">시뮬레이션 일시정지</button>
                    <p class="sim-note">* 실제 API 연동 전 테스트를 위한 가격 시뮬레이션 모드입니다.</p>
                </div>
            </section>

            <!-- Right Panel: Transaction Log -->
            <section class="card history-panel">
                <h2>📜 체결 내역</h2>
                <ul id="trade-log" class="log-list">
                    <!-- Logs will appear here -->
                    <li class="empty-log">체결 내역이 없습니다.</li>
                </ul>
            </section>
        </main>
    </div>

    <script type="module" src="main.js"></script>
</body>
</html>